#!/bin/zsh

# Uncomment during development
# set -x

XRCDIR=$(cd `dirname $0` && pwd)

which brew 2>&1 >/dev/null
if [ $? -ne 0 ]; then
  echo "Unable to find brew. Aborting."
  exit 1
fi

which python3 2>&1 >/dev/null
if [ $? -ne 0 ]; then
  echo "Python 3 not found, installing via brew"
  brew install python3 || exit 1
fi

which nvim 2>&1 >/dev/null
if [ $? -ne 0 ]; then
  echo "Neovim not found, installing via brew"
  brew install neovim || exit 1
  echo "Ensuring python module exists"
  pip3 install neovim || exit 1
fi

if [ ! -d ~/.config ]; then
  mkdir ~/.config
fi

if [ ! -d ~/.config/nvim ]; then
  echo "Linking nvim config"
  ln -sv $XRCDIR/nvim ~/.config
  echo "Installing dein"
  curl https://raw.githubusercontent.com/Shougo/dein.vim/master/bin/installer.sh > /tmp/dein-installer.sh
  sh /tmp/dein-installer.sh ~/.cache/dein
fi

if [ ! -d ~/.config/git ]; then
  echo "Linking git config"
  ln -sv $XRCDIR/git ~/.config
fi

if [ ! -f ~/.ctags ]; then
  echo "Linking ctags config"
  ln -sv $XRCDIR/ctags/ctags ~/.ctags
fi

if [ ! -h ~/.zshrc ]; then
  if [ -f ~/.zshrc ]; then
    echo "Preserving old .zshrc"
    mv -v ~/.zshrc ~/.zshrc.old
  fi
  echo "Linking .zshrc"
  ln -sv $XRCDIR/zshrc ~/.zshrc
fi

if [ ! -f ~/.zimrc ]; then
  echo "Installing zim"
  setopt EXTENDED_GLOB
  for template_file in ${XRCDIR}/zim/templates/*; do
    user_file="${HOME}/.${template_file:t}"
    touch ${user_file}
    ( print -rn "$(<${template_file})$(<${user_file})" >! ${user_file} ) 2>/dev/null
  done
fi

echo "XRC applied and in sync!"
